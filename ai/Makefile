# Compiler settings
CC = gcc
CFLAGS = -Wall -Wextra -g -I.

# The name of your final executable
TARGET = controller

# The source files we write manually
MAIN_SRC = main.c

# The source files generated by the tool
GEN_SRC = statemachine.c
GEN_HEADER = statemachine.h

# --- CHANGED: Tool and Input Names ---
GENERATOR = sm-builder.py
MODEL = first.yaml

# Combine all objects
OBJS = $(MAIN_SRC:.c=.o) $(GEN_SRC:.c=.o)

# ---------------------------------------------------------
# RULES
# ---------------------------------------------------------

all: $(TARGET)

$(TARGET): $(OBJS)
	@echo "Linking $(TARGET)..."
	$(CC) $(CFLAGS) -o $(TARGET) $(OBJS)

main.o: main.c $(GEN_HEADER)
	$(CC) $(CFLAGS) -c main.c -o main.o

statemachine.o: $(GEN_SRC) $(GEN_HEADER)
	$(CC) $(CFLAGS) -c $(GEN_SRC) -o statemachine.o

# Detect changes in first.yaml or sm-builder.py
$(GEN_SRC) $(GEN_HEADER): $(MODEL) $(GENERATOR)
	@echo "Detected change in model. Regenerating state machine..."
	uv run $(GENERATOR) $(MODEL)

clean:
	@echo "Cleaning up..."
	rm -f $(OBJS) $(TARGET) $(GEN_SRC) $(GEN_HEADER)

run: $(TARGET)
	./$(TARGET)

.PHONY: all clean run
