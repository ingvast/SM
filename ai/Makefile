# Compiler settings
CC = gcc
CFLAGS = -Wall -Wextra -gdwarf-4 -I.

# The name of your final executable
TARGET = controller

# The source files we write manually
MAIN_SRC = main.c

# The source files generated by the tool
GEN_SRC = statemachine.c
GEN_HEADER = statemachine.h

# --- CHANGED: Tool and Input Names ---
GENERATOR = sm-builder.py
MODEL = nested-first.yaml

# Combine all objects
OBJS = $(MAIN_SRC:.c=.o) $(GEN_SRC:.c=.o)

# ---------------------------------------------------------
# RULES

# Standard build
all: $(TARGET)

$(TARGET): $(OBJS)
	@echo "Linking $(TARGET)..."
	$(CC) $(CFLAGS) -o $(TARGET) $(OBJS)

main.o: main.c $(GEN_HEADER)
	$(CC) $(CFLAGS) -c main.c -o main.o

statemachine.o: $(GEN_SRC) $(GEN_HEADER)
	$(CC) $(CFLAGS) -c $(GEN_SRC) -o statemachine.o

# If input changes, regenerate C AND DOT
$(GEN_SRC) $(GEN_HEADER): $(MODEL) $(GENERATOR)
	@echo "Regenerating..."
	uv run python3 $(GENERATOR) $(MODEL)

# New Target: Generate and Open Diagram
view: $(GEN_SRC)
	dot -Tpng statemachine.dot -o statemachine.png
	# Tries to open the image (works on Linux/Mac/Windows via generic commands)
	@if [ -x "$$(command -v xdg-open)" ]; then xdg-open statemachine.png; \
	elif [ -x "$$(command -v open)" ]; then open statemachine.png; \
	else echo "Image created: statemachine.png"; fi

clean:
	rm -f $(OBJS) $(TARGET) $(GEN_SRC) $(GEN_HEADER) statemachine.dot statemachine.png
run: $(TARGET)
	./$(TARGET)

.PHONY: all clean run
